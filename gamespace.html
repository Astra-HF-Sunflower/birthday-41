<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>41 & å°å‘æ—¥è‘µå–µçš„æ¸¸æˆç©ºé—´</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        body {
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px currentColor; }
            50% { box-shadow: 0 0 40px currentColor, 0 0 60px currentColor; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        @keyframes cardFlip {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(90deg) scale(1.1); }
            100% { transform: rotateY(180deg) scale(1); }
        }

        @keyframes cardReveal {
            0% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(90deg) scale(1.1); }
            100% { transform: rotateY(0deg) scale(1); }
        }

        @keyframes mysticalGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(147, 51, 234, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(147, 51, 234, 0.8)); }
        }

        @keyframes starFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        .piece-anim {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .board-grid {
            background-color: #fcdfa6;
            background-image: 
                linear-gradient(#d4a356 1px, transparent 1px),
                linear-gradient(90deg, #d4a356 1px, transparent 1px);
            background-size: 6.66% 6.66%;
            background-position: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.2);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .stone-41 {
            background: radial-gradient(circle at 30% 30%, #5eead4, #0f766e);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        
        .stone-sunflower {
            background: radial-gradient(circle at 30% 30%, #7dd3fc, #0369a1);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .last-move::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40%;
            height: 40%;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        /* Pong Game Styles */
        .pong-canvas {
            background: linear-gradient(135deg, #0c1220 0%, #1a1a2e 50%, #0c1220 100%);
        }

        .neon-text-teal {
            text-shadow: 0 0 10px #14b8a6, 0 0 20px #14b8a6, 0 0 40px #14b8a6;
        }

        .neon-text-blue {
            text-shadow: 0 0 10px #0ea5e9, 0 0 20px #0ea5e9, 0 0 40px #0ea5e9;
        }

        .glow-teal {
            box-shadow: 0 0 15px #14b8a6, 0 0 30px #14b8a6;
        }

        .glow-blue {
            box-shadow: 0 0 15px #0ea5e9, 0 0 30px #0ea5e9;
        }

        .screen-shake {
            animation: shake 0.3s ease-in-out;
        }

        /* Tarot Styles */
        .tarot-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }

        .mystical-glow {
            animation: mysticalGlow 2s ease-in-out infinite;
        }

        .tarot-card {
            perspective: 1000px;
            transform-style: preserve-3d;
        }

        .tarot-card-inner {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .tarot-card.flipped .tarot-card-inner {
            transform: rotateY(180deg);
        }

        .tarot-card-front, .tarot-card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .tarot-card-back {
            transform: rotateY(180deg);
        }

        .card-back-pattern {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #4c1d95 100%);
            background-size: 400% 400%;
            animation: shimmer 3s ease infinite;
        }

        .star-decoration {
            animation: starFloat 3s ease-in-out infinite;
        }

        .gold-text {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .purple-glow {
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.4), 0 0 40px rgba(147, 51, 234, 0.2);
        }

        .tarot-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.3);
        }
    </style>
</head>
<body class="h-screen w-screen bg-gradient-to-br from-teal-100 via-white to-sky-100 overflow-hidden relative">

    <!-- MAIN MENU -->
    <div id="main-menu" class="absolute inset-0 flex flex-col items-center justify-center p-6 transition-all duration-500 z-10">
        <div class="text-center mb-10 floating">
            <h1 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-sky-500 drop-shadow-sm mb-2">
                æ¸¸æˆç©ºé—´
            </h1>
            <p class="text-gray-500 text-lg">41 & å°å‘æ—¥è‘µå–µ</p>
        </div>

        <div class="grid grid-cols-1 gap-6 w-full max-w-sm">
            <!-- Gomoku Button -->
            <button onclick="startGame('gomoku')" class="btn-press glass-panel rounded-2xl p-6 flex items-center justify-between group hover:bg-white transition-colors cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-teal-400 to-sky-400 flex items-center justify-center text-white text-2xl shadow-lg">
                        âš«
                    </div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-gray-800">äº”å­æ£‹å¤§æˆ˜</h3>
                        <p class="text-xs text-gray-500">è°æ˜¯æœ€åçš„èµ¢å®¶ï¼Ÿ</p>
                    </div>
                </div>
                <span class="text-2xl group-hover:translate-x-1 transition-transform">â¡ï¸</span>
            </button>
            
            <!-- Pong Button -->
            <button onclick="startGame('pong')" class="btn-press glass-panel rounded-2xl p-6 flex items-center justify-between group hover:bg-white transition-colors cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-white text-2xl shadow-lg">
                        ğŸ“
                    </div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-gray-800">å¼¹çƒå¤§ä½œæˆ˜</h3>
                        <p class="text-xs text-gray-500">åŒå±å¯¹å†³ï¼è°çš„ååº”æ›´å¿«ï¼Ÿ</p>
                    </div>
                </div>
                <span class="text-2xl group-hover:translate-x-1 transition-transform">â¡ï¸</span>
            </button>
            
            <!-- Tarot Button -->
            <button onclick="startGame('tarot')" class="btn-press glass-panel rounded-2xl p-6 flex items-center justify-between group hover:bg-white transition-colors cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-600 to-indigo-600 flex items-center justify-center text-white text-2xl shadow-lg">
                        ğŸ”®
                    </div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-gray-800">å¡”ç½—ç‰Œå åœ</h3>
                        <p class="text-xs text-gray-500">æ¢ç´¢å‘½è¿çš„å¥¥ç§˜~</p>
                    </div>
                </div>
                <span class="text-2xl group-hover:translate-x-1 transition-transform">â¡ï¸</span>
            </button>
            
            <!-- Territory Button -->
            <button onclick="startGame('territory')" class="btn-press glass-panel rounded-2xl p-6 flex items-center justify-between group hover:bg-white transition-colors cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-emerald-500 to-cyan-500 flex items-center justify-center text-white text-2xl shadow-lg">
                        ğŸ¯
                    </div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-gray-800">å¼¹çƒæŠ¢åœ°ç›˜</h3>
                        <p class="text-xs text-gray-500">ç”¨å¼¹çƒå é¢†æ›´å¤šæ ¼å­ï¼</p>
                    </div>
                </div>
                <span class="text-2xl group-hover:translate-x-1 transition-transform">â¡ï¸</span>
            </button>
        </div>
    </div>

    <!-- GOMOKU GAME SCREEN -->
    <div id="gomoku-screen" class="absolute inset-0 bg-stone-100 flex flex-col items-center translate-x-full transition-transform duration-500 z-20">
        <div class="w-full pt-4 pb-2 px-4 flex justify-between items-center bg-white shadow-sm z-30">
            <button onclick="backToMenu()" class="btn-press text-gray-500 font-bold p-2 rounded-full hover:bg-gray-100">
                â¬…ï¸ é€€å‡º
            </button>
            <div class="text-xl font-bold text-gray-700">äº”å­æ£‹</div>
            <button onclick="resetGomoku()" class="btn-press text-teal-600 font-bold p-2 rounded-full hover:bg-teal-50 text-sm border border-teal-200">
                é‡å¼€
            </button>
        </div>

        <div class="w-full flex justify-around items-center py-4 px-2">
            <div id="p1-card" class="glass-panel rounded-xl p-3 flex flex-col items-center w-5/12 transition-all duration-300 border-2 border-teal-400 shadow-teal-100">
                <div class="w-10 h-10 rounded-full bg-teal-400 shadow-md mb-1 border-2 border-white"></div>
                <span class="font-bold text-teal-700">41</span>
                <span id="p1-status" class="text-xs text-teal-500 font-bold mt-1">æ€è€ƒä¸­...</span>
            </div>
            
            <div class="text-gray-300 font-bold text-xl">VS</div>

            <div id="p2-card" class="glass-panel rounded-xl p-3 flex flex-col items-center w-5/12 transition-all duration-300 opacity-60 border-2 border-transparent">
                <div class="w-10 h-10 rounded-full bg-sky-400 shadow-md mb-1 border-2 border-white"></div>
                <span class="font-bold text-sky-700">å°å‘æ—¥è‘µå–µ</span>
                <span id="p2-status" class="text-xs text-sky-500 font-bold mt-1 hidden">æ€è€ƒä¸­...</span>
            </div>
        </div>

        <div class="flex-1 w-full flex items-center justify-center p-4">
            <div class="relative w-full max-w-md aspect-square bg-[#e8c37e] rounded-lg shadow-2xl p-2 border-4 border-[#b58863]">
                <div class="w-full h-full relative board-grid" id="board-container"></div>
            </div>
        </div>

        <div class="w-full pb-8 pt-2 px-6 flex justify-between items-center gap-4">
            <button onclick="undoMove()" class="btn-press flex-1 glass-panel py-3 rounded-xl text-amber-600 font-bold border-amber-200 hover:bg-amber-50 shadow-sm flex items-center justify-center gap-2">
                <span>â†©ï¸</span> æ‚”æ£‹
            </button>
            <button onclick="switchFirst()" class="btn-press flex-1 glass-panel py-3 rounded-xl text-purple-600 font-bold border-purple-200 hover:bg-purple-50 shadow-sm flex items-center justify-center gap-2">
                <span>ğŸ”„</span> æ¢å…ˆæ‰‹
            </button>
        </div>

        <!-- Winner Modal -->
        <div id="winner-modal" class="absolute inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center animate-[popIn_0.4s_ease-out]">
                <div id="winner-icon" class="text-6xl mb-4 floating">ğŸ†</div>
                <h2 id="winner-title" class="text-3xl font-bold mb-2 text-gray-800">èƒœåˆ©!</h2>
                <p id="winner-msg" class="text-gray-500 mb-6 text-lg italic">å¤ªå¼ºäº†ï¼</p>
                
                <div class="flex gap-3">
                    <button onclick="closeModalAndReset()" class="flex-1 bg-gradient-to-r from-teal-400 to-sky-400 text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 active:scale-95 transition-all">
                        å†æ¥ä¸€å±€
                    </button>
                    <button onclick="backToMenuFromModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 active:scale-95 transition-all">
                        ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PONG GAME SCREEN -->
    <div id="pong-screen" class="absolute inset-0 flex flex-col translate-x-full transition-transform duration-500 z-20">
        
        <!-- Pong Setup Screen -->
        <div id="pong-setup" class="absolute inset-0 bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex flex-col items-center justify-center p-6 z-30">
            <button onclick="backToMenu()" class="absolute top-4 left-4 text-white/70 font-bold p-2 rounded-full hover:bg-white/10">
                â¬…ï¸ è¿”å›
            </button>
            
            <h1 class="text-4xl font-bold text-white mb-2 neon-text-teal">å¼¹çƒå¤§ä½œæˆ˜</h1>
            <p class="text-purple-300 mb-8">ä¸‰å±€ä¸¤èƒœ Â· æ¯å±€äº”åˆ†</p>
            
            <div class="glass-panel rounded-2xl p-6 w-full max-w-sm bg-white/10 border-purple-500/30">
                <h3 class="text-white text-lg font-bold mb-4 text-center">é€‰æ‹©çƒçš„æ•°é‡</h3>
                <div class="flex justify-center gap-4 mb-6">
                    <button onclick="selectBallCount(1)" class="ball-count-btn w-16 h-16 rounded-xl bg-purple-600 text-white text-2xl font-bold flex items-center justify-center hover:bg-purple-500 transition-all border-2 border-transparent" data-count="1">1</button>
                    <button onclick="selectBallCount(2)" class="ball-count-btn w-16 h-16 rounded-xl bg-purple-600/50 text-white text-2xl font-bold flex items-center justify-center hover:bg-purple-500 transition-all border-2 border-transparent" data-count="2">2</button>
                    <button onclick="selectBallCount(3)" class="ball-count-btn w-16 h-16 rounded-xl bg-purple-600/50 text-white text-2xl font-bold flex items-center justify-center hover:bg-purple-500 transition-all border-2 border-transparent" data-count="3">3</button>
                </div>
                
                <div class="flex gap-4 text-center text-sm text-white/60 mb-6">
                    <div class="flex-1">
                        <div class="w-8 h-8 rounded bg-teal-500 glow-teal mx-auto mb-1"></div>
                        <span>41 (ä¸Šæ–¹)</span>
                    </div>
                    <div class="flex-1">
                        <div class="w-8 h-8 rounded bg-sky-500 glow-blue mx-auto mb-1"></div>
                        <span>å°å‘æ—¥è‘µå–µ (ä¸‹æ–¹)</span>
                    </div>
                </div>
                
                <button onclick="startPongGame()" class="w-full py-4 rounded-xl bg-gradient-to-r from-teal-500 to-sky-500 text-white text-xl font-bold shadow-lg hover:opacity-90 active:scale-95 transition-all">
                    å¼€å§‹å¯¹å†³ï¼
                </button>
            </div>
            
            <p class="text-white/40 text-sm mt-6 text-center">æ“ä½œï¼šè§¦æ‘¸å±å¹•ä¸Š/ä¸‹åŠè¾¹å·¦å³æ»‘åŠ¨æ§åˆ¶å„è‡ªçš„æŒ¡æ¿</p>
        </div>
        
        <!-- Pong Game Area -->
        <div id="pong-game" class="absolute inset-0 hidden">
            <canvas id="pong-canvas" class="w-full h-full pong-canvas"></canvas>
            
            <!-- Score Display -->
            <div class="absolute top-4 left-0 right-0 flex justify-center items-center gap-4 pointer-events-none">
                <div class="text-center">
                    <div class="text-teal-400 text-xs mb-1">41</div>
                    <div id="pong-score-1" class="text-4xl font-bold text-teal-400 neon-text-teal">0</div>
                </div>
                <div class="text-white/30 text-2xl">:</div>
                <div class="text-center">
                    <div class="text-sky-400 text-xs mb-1">å°å‘æ—¥è‘µå–µ</div>
                    <div id="pong-score-2" class="text-4xl font-bold text-sky-400 neon-text-blue">0</div>
                </div>
            </div>
            
            <!-- Round Display -->
            <div class="absolute top-20 left-0 right-0 flex justify-center pointer-events-none">
                <div class="bg-black/50 px-4 py-1 rounded-full">
                    <span class="text-white/70 text-sm">ç¬¬ <span id="pong-round" class="text-yellow-400">1</span> / 3 å±€</span>
                    <span class="text-white/50 mx-2">|</span>
                    <span class="text-teal-400" id="round-score-1">0</span>
                    <span class="text-white/50"> - </span>
                    <span class="text-sky-400" id="round-score-2">0</span>
                </div>
            </div>
            
            <!-- Pause/Menu Button -->
            <button onclick="pausePong()" class="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30">
                â¸ï¸
            </button>
        </div>
        
        <!-- Pong Pause Modal -->
        <div id="pong-pause-modal" class="absolute inset-0 bg-black/70 z-40 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-gray-800 rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center">
                <h2 class="text-2xl font-bold text-white mb-6">æ¸¸æˆæš‚åœ</h2>
                <div class="flex flex-col gap-3">
                    <button onclick="resumePong()" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold">
                        ç»§ç»­æ¸¸æˆ
                    </button>
                    <button onclick="restartPong()" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold">
                        é‡æ–°å¼€å§‹
                    </button>
                    <button onclick="exitPong()" class="w-full py-3 rounded-xl bg-gray-600 text-white font-bold">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Pong Round/Match End Modal -->
        <div id="pong-end-modal" class="absolute inset-0 bg-black/70 z-40 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-gray-800 rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center animate-[popIn_0.4s_ease-out]">
                <div id="pong-end-icon" class="text-6xl mb-4 floating">ğŸ‰</div>
                <h2 id="pong-end-title" class="text-2xl font-bold text-white mb-2">æœ¬å±€ç»“æŸ</h2>
                <p id="pong-end-msg" class="text-gray-400 mb-6 text-lg italic">ç»§ç»­åŠ æ²¹ï¼</p>
                
                <div id="pong-end-buttons" class="flex flex-col gap-3">
                    <!-- Buttons inserted dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- TAROT SCREEN -->
    <div id="tarot-screen" class="absolute inset-0 tarot-bg translate-x-full transition-transform duration-500 z-20 overflow-y-auto">
        <!-- Decorative Stars -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <div class="absolute top-20 left-10 text-2xl star-decoration" style="animation-delay: 0s;">âœ¨</div>
            <div class="absolute top-40 right-16 text-xl star-decoration" style="animation-delay: 0.5s;">â­</div>
            <div class="absolute bottom-40 left-20 text-2xl star-decoration" style="animation-delay: 1s;">âœ¨</div>
            <div class="absolute bottom-60 right-10 text-xl star-decoration" style="animation-delay: 1.5s;">ğŸŒŸ</div>
            <div class="absolute top-1/3 left-1/4 text-lg star-decoration" style="animation-delay: 2s;">âœ¨</div>
        </div>

        <!-- Header -->
        <div class="w-full pt-4 pb-2 px-4 flex justify-between items-center z-30 relative">
            <button onclick="backToMenu()" class="btn-press text-purple-300 font-bold p-2 rounded-full hover:bg-white/10">
                â¬…ï¸ è¿”å›
            </button>
            <div class="text-xl font-bold gold-text">ğŸ”® å¡”ç½—å åœ</div>
            <button onclick="resetTarot()" class="btn-press text-purple-300 font-bold p-2 rounded-full hover:bg-white/10 text-sm">
                ğŸ”„ é‡æ¥
            </button>
        </div>

        <!-- Tarot Content Container -->
        <div id="tarot-content" class="px-4 pb-8">
            
            <!-- Step 1: Input Question -->
            <div id="tarot-step-1" class="max-w-md mx-auto">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4 mystical-glow inline-block">ğŸ”®</div>
                    <h2 class="text-2xl font-bold text-purple-200 mb-2">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜</h2>
                    <p class="text-purple-400 text-sm">è®©å®‡å®™æ„Ÿåº”ä½ çš„èƒ½é‡...</p>
                </div>

                <div class="bg-white/10 rounded-2xl p-6 purple-glow mb-6">
                    <label class="block text-purple-300 text-sm mb-2">âœ¨ ä½ æƒ³é—®ä»€ä¹ˆï¼Ÿ</label>
                    <textarea id="tarot-question" class="w-full bg-white/10 border border-purple-500/30 rounded-xl p-4 text-white placeholder-purple-400/50 tarot-input resize-none" rows="3" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ„Ÿæƒ…è¿åŠ¿å¦‚ä½•ï¼Ÿ"></textarea>
                </div>

                <div class="bg-white/10 rounded-2xl p-6 purple-glow mb-6">
                    <label class="block text-purple-300 text-sm mb-4">ğŸŒ™ é€‰æ‹©ç‰Œé˜µ</label>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="selectSpread('single')" class="spread-btn btn-press bg-gradient-to-r from-purple-600/50 to-indigo-600/50 border-2 border-purple-500/50 rounded-xl p-4 text-left hover:border-purple-400 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ´</span>
                                <div>
                                    <div class="text-white font-bold">å•ç‰Œå åœ</div>
                                    <div class="text-purple-300 text-xs">ç®€å•ç›´æ¥ï¼Œé€‚åˆæ˜¯éé¢˜</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="selectSpread('three')" class="spread-btn btn-press bg-gradient-to-r from-purple-600/50 to-indigo-600/50 border-2 border-purple-500/50 rounded-xl p-4 text-left hover:border-purple-400 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸƒ</span>
                                <div>
                                    <div class="text-white font-bold">æ—¶é—´ä¹‹æµï¼ˆä¸‰ç‰Œï¼‰</div>
                                    <div class="text-purple-300 text-xs">è¿‡å» Â· ç°åœ¨ Â· æœªæ¥</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="selectSpread('love')" class="spread-btn btn-press bg-gradient-to-r from-pink-600/50 to-purple-600/50 border-2 border-pink-500/50 rounded-xl p-4 text-left hover:border-pink-400 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ’•</span>
                                <div>
                                    <div class="text-white font-bold">çˆ±æƒ…å åœï¼ˆä¸‰ç‰Œï¼‰</div>
                                    <div class="text-pink-300 text-xs">ä½  Â· å¯¹æ–¹ Â· å…³ç³»èµ°å‘</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="selectSpread('cross')" class="spread-btn btn-press bg-gradient-to-r from-indigo-600/50 to-purple-600/50 border-2 border-indigo-500/50 rounded-xl p-4 text-left hover:border-indigo-400 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">âœï¸</span>
                                <div>
                                    <div class="text-white font-bold">åå­—ç‰Œé˜µï¼ˆäº”ç‰Œï¼‰</div>
                                    <div class="text-indigo-300 text-xs">å…¨é¢åˆ†æï¼Œæ·±åº¦è§£è¯»</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <button onclick="startReading()" id="start-reading-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xl font-bold shadow-lg hover:opacity-90 active:scale-95 transition-all purple-glow disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    âœ¨ å¼€å§‹å åœ
                </button>
            </div>

            <!-- Step 2: Card Selection -->
            <div id="tarot-step-2" class="hidden max-w-lg mx-auto">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-purple-200 mb-2">é€‰æ‹©ä½ çš„ç‰Œ</h2>
                    <p class="text-purple-400 text-sm" id="card-instruction">ç”¨å¿ƒæ„Ÿåº”ï¼Œç‚¹å‡»é€‰æ‹© <span id="cards-remaining">1</span> å¼ ç‰Œ</p>
                </div>

                <div id="card-deck" class="flex flex-wrap justify-center gap-2 mb-6">
                    <!-- Cards will be generated here -->
                </div>

                <div id="selected-cards-preview" class="flex justify-center gap-4 mb-4">
                    <!-- Selected card previews -->
                </div>
            </div>

            <!-- Step 3: Reading Result -->
            <div id="tarot-step-3" class="hidden max-w-lg mx-auto">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold gold-text mb-2">ğŸŒŸ å åœç»“æœ ğŸŒŸ</h2>
                    <p class="text-purple-300 text-sm" id="result-question"></p>
                </div>

                <div id="result-cards" class="flex flex-wrap justify-center gap-4 mb-6">
                    <!-- Result cards will be shown here -->
                </div>

                <div id="reading-interpretation" class="bg-white/10 rounded-2xl p-6 purple-glow mb-6">
                    <!-- Interpretation will be shown here -->
                </div>

                <div class="flex gap-3">
                    <button onclick="resetTarot()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold shadow-lg hover:opacity-90 active:scale-95 transition-all">
                        ğŸ”® å†å ä¸€å¦
                    </button>
                    <button onclick="backToMenu()" class="flex-1 py-3 rounded-xl bg-white/20 text-purple-200 font-bold hover:bg-white/30 active:scale-95 transition-all">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TERRITORY GAME SCREEN -->
    <div id="territory-screen" class="absolute inset-0 flex flex-col translate-x-full transition-transform duration-500 z-20">
        
        <!-- Territory Setup Screen -->
        <div id="territory-setup" class="absolute inset-0 bg-gradient-to-br from-emerald-900 via-gray-900 to-cyan-900 flex flex-col items-center justify-center p-6 z-30">
            <button onclick="backToMenu()" class="absolute top-4 left-4 text-white/70 font-bold p-2 rounded-full hover:bg-white/10">
                â¬…ï¸ è¿”å›
            </button>
            
            <h1 class="text-4xl font-bold text-white mb-2" style="text-shadow: 0 0 20px #14b8a6, 0 0 40px #14b8a6;">å¼¹çƒæŠ¢åœ°ç›˜</h1>
            <p class="text-emerald-300 mb-8">ç”¨å¼¹çƒå é¢†æ›´å¤šæ ¼å­è·èƒœï¼</p>
            
            <div class="glass-panel rounded-2xl p-6 w-full max-w-sm bg-white/10 border-emerald-500/30">
                <h3 class="text-white text-lg font-bold mb-4 text-center">æ¸¸æˆæ—¶é•¿</h3>
                <div class="flex justify-center gap-4 mb-6">
                    <button onclick="selectDuration(30)" class="duration-btn w-20 h-16 rounded-xl bg-emerald-600 text-white text-lg font-bold flex flex-col items-center justify-center hover:bg-emerald-500 transition-all border-2 border-transparent" data-duration="30">
                        <span class="text-2xl">30</span>
                        <span class="text-xs">ç§’</span>
                    </button>
                    <button onclick="selectDuration(60)" class="duration-btn w-20 h-16 rounded-xl bg-emerald-600/50 text-white text-lg font-bold flex flex-col items-center justify-center hover:bg-emerald-500 transition-all border-2 border-transparent" data-duration="60">
                        <span class="text-2xl">60</span>
                        <span class="text-xs">ç§’</span>
                    </button>
                    <button onclick="selectDuration(90)" class="duration-btn w-20 h-16 rounded-xl bg-emerald-600/50 text-white text-lg font-bold flex flex-col items-center justify-center hover:bg-emerald-500 transition-all border-2 border-transparent" data-duration="90">
                        <span class="text-2xl">90</span>
                        <span class="text-xs">ç§’</span>
                    </button>
                </div>
                
                <div class="flex gap-4 text-center text-sm text-white/60 mb-6">
                    <div class="flex-1">
                        <div class="w-8 h-8 rounded bg-teal-500 glow-teal mx-auto mb-1"></div>
                        <span>41 (ä¸Šæ–¹)</span>
                    </div>
                    <div class="flex-1">
                        <div class="w-8 h-8 rounded bg-sky-500 glow-blue mx-auto mb-1"></div>
                        <span>å°å‘æ—¥è‘µå–µ (ä¸‹æ–¹)</span>
                    </div>
                </div>
                
                <button onclick="startTerritoryGame()" class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 text-white text-xl font-bold shadow-lg hover:opacity-90 active:scale-95 transition-all">
                    å¼€å§‹æŠ¢åœ°ç›˜ï¼
                </button>
            </div>
            
            <div class="text-white/40 text-sm mt-6 text-center max-w-xs">
                <p>ğŸ® æ“ä½œï¼šè§¦æ‘¸å±å¹•ä¸Š/ä¸‹åŠè¾¹å·¦å³æ»‘åŠ¨</p>
                <p class="mt-1">ğŸ¯ çƒç¢°åˆ°æ ¼å­å°±èƒ½å é¢†å®ƒï¼</p>
            </div>
        </div>
        
        <!-- Territory Game Area -->
        <div id="territory-game" class="absolute inset-0 hidden">
            <canvas id="territory-canvas" class="w-full h-full"></canvas>
            
            <!-- Timer and Score Display -->
            <div class="absolute top-4 left-0 right-0 flex justify-center items-center gap-6 pointer-events-none">
                <div class="text-center">
                    <div class="text-teal-400 text-xs mb-1">41</div>
                    <div id="territory-score-1" class="text-3xl font-bold text-teal-400 neon-text-teal">0</div>
                </div>
                <div class="text-center bg-black/50 px-4 py-2 rounded-full">
                    <div class="text-yellow-400 text-2xl font-bold" id="territory-timer">60</div>
                </div>
                <div class="text-center">
                    <div class="text-sky-400 text-xs mb-1">å°å‘æ—¥è‘µå–µ</div>
                    <div id="territory-score-2" class="text-3xl font-bold text-sky-400 neon-text-blue">0</div>
                </div>
            </div>
            
            <!-- Pause Button -->
            <button onclick="pauseTerritory()" class="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30">
                â¸ï¸
            </button>
        </div>
        
        <!-- Territory Pause Modal -->
        <div id="territory-pause-modal" class="absolute inset-0 bg-black/70 z-40 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-gray-800 rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center">
                <h2 class="text-2xl font-bold text-white mb-6">æ¸¸æˆæš‚åœ</h2>
                <div class="flex flex-col gap-3">
                    <button onclick="resumeTerritory()" class="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-bold">
                        ç»§ç»­æ¸¸æˆ
                    </button>
                    <button onclick="restartTerritory()" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold">
                        é‡æ–°å¼€å§‹
                    </button>
                    <button onclick="exitTerritory()" class="w-full py-3 rounded-xl bg-gray-600 text-white font-bold">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Territory End Modal -->
        <div id="territory-end-modal" class="absolute inset-0 bg-black/70 z-40 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-gray-800 rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center animate-[popIn_0.4s_ease-out]">
                <div id="territory-end-icon" class="text-6xl mb-4 floating">ğŸ†</div>
                <h2 id="territory-end-title" class="text-2xl font-bold text-white mb-2">æ¸¸æˆç»“æŸ</h2>
                <div id="territory-final-score" class="text-lg text-gray-300 mb-2"></div>
                <p id="territory-end-msg" class="text-gray-400 mb-6 text-lg italic"></p>
                
                <div class="flex flex-col gap-3">
                    <button onclick="restartTerritory()" class="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-bold">
                        å†æ¥ä¸€å±€
                    </button>
                    <button onclick="exitTerritory()" class="w-full py-3 rounded-xl bg-gray-600 text-white font-bold">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AUDIO SYSTEM ====================
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioCtx();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(freq, type = 'sine', duration = 0.1, volume = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playPlaceSound() {
            playTone(400, 'sine', 0.15);
        }

        function playWinSound() {
            setTimeout(() => playTone(523.25, 'triangle', 0.2), 0);
            setTimeout(() => playTone(659.25, 'triangle', 0.2), 200);
            setTimeout(() => playTone(783.99, 'triangle', 0.4), 400);
            setTimeout(() => playTone(1046.50, 'triangle', 0.6), 600);
        }

        function playPaddleHit() {
            playTone(300 + Math.random() * 200, 'square', 0.05, 0.08);
        }

        function playWallHit() {
            playTone(200, 'triangle', 0.08, 0.05);
        }

        function playScoreSound(isPlayer1) {
            const baseFreq = isPlayer1 ? 523 : 440;
            playTone(baseFreq, 'sawtooth', 0.3, 0.15);
            setTimeout(() => playTone(baseFreq * 1.5, 'sawtooth', 0.2, 0.1), 100);
        }

        function playRoundWinSound() {
            [0, 100, 200, 300, 400].forEach((delay, i) => {
                setTimeout(() => playTone(400 + i * 100, 'triangle', 0.15, 0.1), delay);
            });
        }

        function playMysticalSound() {
            playTone(220, 'sine', 0.3, 0.08);
            setTimeout(() => playTone(330, 'sine', 0.3, 0.06), 100);
            setTimeout(() => playTone(440, 'sine', 0.4, 0.05), 200);
        }

        function playCardFlipSound() {
            playTone(800, 'sine', 0.1, 0.05);
            setTimeout(() => playTone(1000, 'sine', 0.15, 0.04), 50);
        }

        // ==================== NAVIGATION ====================
        function startGame(gameType) {
            initAudio();
            document.getElementById('main-menu').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('main-menu').style.display = 'none';
            }, 500);

            if (gameType === 'gomoku') {
                const gameScreen = document.getElementById('gomoku-screen');
                gameScreen.classList.remove('translate-x-full');
                initBoardGrid();
                resetGomoku();
            } else if (gameType === 'pong') {
                const gameScreen = document.getElementById('pong-screen');
                gameScreen.classList.remove('translate-x-full');
                document.getElementById('pong-setup').classList.remove('hidden');
                document.getElementById('pong-game').classList.add('hidden');
            } else if (gameType === 'tarot') {
                const gameScreen = document.getElementById('tarot-screen');
                gameScreen.classList.remove('translate-x-full');
                resetTarot();
            } else if (gameType === 'territory') {
                const gameScreen = document.getElementById('territory-screen');
                gameScreen.classList.remove('translate-x-full');
                document.getElementById('territory-setup').classList.remove('hidden');
                document.getElementById('territory-game').classList.add('hidden');
            }
        }

        function backToMenu() {
            // Hide all game screens
            document.getElementById('gomoku-screen').classList.add('translate-x-full');
            document.getElementById('pong-screen').classList.add('translate-x-full');
            document.getElementById('tarot-screen').classList.add('translate-x-full');
            document.getElementById('territory-screen').classList.add('translate-x-full');
            
            // Stop pong if running
            if (pongAnimationId) {
                cancelAnimationFrame(pongAnimationId);
                pongAnimationId = null;
            }
            
            // Stop territory if running
            if (territoryAnimationId) {
                cancelAnimationFrame(territoryAnimationId);
                territoryAnimationId = null;
            }
            if (territoryTimerId) {
                clearInterval(territoryTimerId);
                territoryTimerId = null;
            }
            
            const menu = document.getElementById('main-menu');
            menu.style.display = 'flex';
            setTimeout(() => {
                menu.classList.remove('opacity-0', 'pointer-events-none');
            }, 100);
        }

        function backToMenuFromModal() {
            document.getElementById('winner-modal').classList.add('hidden');
            backToMenu();
        }

        // ==================== GOMOKU GAME ====================
        const BOARD_SIZE = 15;
        let board = [];
        let currentPlayer = 1;
        let history = [];
        let gameActive = false;
        let firstPlayer = 1;

        const winMsgs41 = [
            "å“¼ï¼Œ41æ‰æ˜¯æœ€å‰å®³çš„ï¼",
            "å°å‘æ—¥è‘µå–µè¿˜è¦å†ç»ƒç»ƒå“¦ï¼",
            "è½»æ¾æ‹¿ä¸‹ï¼å–µå–µä¹Ÿæ²¡ç”¨ï¼",
            "è¿™å°±æ˜¯å®åŠ›çš„å·®è·ï¼"
        ];
        
        const winMsgsSunflower = [
            "å°å‘æ—¥è‘µå–µå¤§èƒœåˆ©ï¼",
            "å–µå–µæ‹³æ— æ•Œï¼",
            "41å¤§æ„äº†æ²¡æœ‰é—ªï¼",
            "è¿™å±€å½’æˆ‘å•¦ï¼å–µå‘œï¼"
        ];

        const boardEl = document.getElementById('board-container');
        
        function initBoardGrid() {
            boardEl.innerHTML = '';
            for (let y = 0; y < BOARD_SIZE; y++) {
                for (let x = 0; x < BOARD_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'absolute w-[6.66%] h-[6.66%] flex items-center justify-center cursor-pointer';
                    cell.style.left = (x * 6.66) + '%';
                    cell.style.top = (y * 6.66) + '%';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.onclick = () => handleMove(x, y);
                    boardEl.appendChild(cell);
                }
            }
        }

        function resetGomoku() {
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            history = [];
            gameActive = true;
            currentPlayer = firstPlayer;
            updateGomokuUI();
            
            const cells = boardEl.children;
            for (let cell of cells) {
                cell.innerHTML = '';
                cell.classList.remove('last-move');
            }
            document.getElementById('winner-modal').classList.add('hidden');
        }

        function switchFirst() {
            firstPlayer = firstPlayer === 1 ? 2 : 1;
            resetGomoku();
            
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… å·²åˆ‡æ¢';
            setTimeout(() => btn.innerHTML = originalText, 1000);
        }

        function handleMove(x, y) {
            if (!gameActive) return;
            if (board[y][x] !== 0) return;

            board[y][x] = currentPlayer;
            history.push({x, y, player: currentPlayer});
            
            renderStone(x, y, currentPlayer);
            playPlaceSound();

            if (checkWin(x, y, currentPlayer)) {
                gameActive = false;
                setTimeout(() => showGomokuWinner(currentPlayer), 500);
                return;
            }

            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateGomokuUI();
        }

        function renderStone(x, y, player) {
            const cellIndex = y * BOARD_SIZE + x;
            const cell = boardEl.children[cellIndex];
            
            const prevLast = boardEl.querySelector('.last-move');
            if (prevLast) prevLast.classList.remove('last-move');

            const stone = document.createElement('div');
            stone.className = `w-[85%] h-[85%] rounded-full piece-anim ${player === 1 ? 'stone-41' : 'stone-sunflower'}`;
            cell.appendChild(stone);
            cell.classList.add('last-move');
        }

        function undoMove() {
            if (history.length === 0 || !gameActive) return;
            
            const lastMove = history.pop();
            board[lastMove.y][lastMove.x] = 0;
            
            const cellIndex = lastMove.y * BOARD_SIZE + lastMove.x;
            const cell = boardEl.children[cellIndex];
            cell.innerHTML = '';
            cell.classList.remove('last-move');

            if (history.length > 0) {
                const prevMove = history[history.length - 1];
                const prevIndex = prevMove.y * BOARD_SIZE + prevMove.x;
                boardEl.children[prevIndex].classList.add('last-move');
            }

            currentPlayer = lastMove.player;
            updateGomokuUI();
        }

        function updateGomokuUI() {
            const p1Card = document.getElementById('p1-card');
            const p2Card = document.getElementById('p2-card');
            const p1Status = document.getElementById('p1-status');
            const p2Status = document.getElementById('p2-status');

            if (currentPlayer === 1) {
                p1Card.classList.remove('opacity-60', 'border-transparent');
                p1Card.classList.add('border-teal-400', 'shadow-teal-100');
                p1Status.classList.remove('hidden');
                
                p2Card.classList.add('opacity-60', 'border-transparent');
                p2Card.classList.remove('border-sky-400', 'shadow-sky-100');
                p2Status.classList.add('hidden');
            } else {
                p2Card.classList.remove('opacity-60', 'border-transparent');
                p2Card.classList.add('border-sky-400', 'shadow-sky-100');
                p2Status.classList.remove('hidden');

                p1Card.classList.add('opacity-60', 'border-transparent');
                p1Card.classList.remove('border-teal-400', 'shadow-teal-100');
                p1Status.classList.add('hidden');
            }
        }

        function checkWin(x, y, player) {
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];

            for (let [dx, dy] of directions) {
                let count = 1;
                
                let i = 1;
                while (true) {
                    const nx = x + dx * i;
                    const ny = y + dy * i;
                    if (nx < 0 || nx >= BOARD_SIZE || ny < 0 || ny >= BOARD_SIZE) break;
                    if (board[ny][nx] !== player) break;
                    count++;
                    i++;
                }

                i = 1;
                while (true) {
                    const nx = x - dx * i;
                    const ny = y - dy * i;
                    if (nx < 0 || nx >= BOARD_SIZE || ny < 0 || ny >= BOARD_SIZE) break;
                    if (board[ny][nx] !== player) break;
                    count++;
                    i++;
                }

                if (count >= 5) return true;
            }
            return false;
        }

        function showGomokuWinner(player) {
            playWinSound();
            const modal = document.getElementById('winner-modal');
            const title = document.getElementById('winner-title');
            const msg = document.getElementById('winner-msg');
            const icon = document.getElementById('winner-icon');

            modal.classList.remove('hidden');

            if (player === 1) {
                title.innerText = "41 è·èƒœ!";
                title.className = "text-3xl font-bold mb-2 text-teal-600";
                msg.innerText = winMsgs41[Math.floor(Math.random() * winMsgs41.length)];
                icon.innerText = "ğŸƒ";
            } else {
                title.innerText = "å°å‘æ—¥è‘µå–µ è·èƒœ!";
                title.className = "text-3xl font-bold mb-2 text-sky-600";
                msg.innerText = winMsgsSunflower[Math.floor(Math.random() * winMsgsSunflower.length)];
                icon.innerText = "ğŸŒ»";
            }
        }

        function closeModalAndReset() {
            document.getElementById('winner-modal').classList.add('hidden');
            resetGomoku();
        }

        initBoardGrid();

        // ==================== PONG GAME ====================
        let pongCanvas, pongCtx;
        let pongAnimationId = null;
        let pongBallCount = 1;
        let pongPaused = false;
        
        // Game state
        let pongState = {
            score1: 0,
            score2: 0,
            roundScore1: 0,
            roundScore2: 0,
            currentRound: 1,
            maxRounds: 3,
            pointsToWin: 5,
            balls: [],
            particles: [],
            trails: []
        };

        // Paddle and ball config
        const paddleWidth = 120;
        const paddleHeight = 15;
        const ballRadius = 12;
        
        let paddle1X, paddle2X;
        let touchX1 = null, touchX2 = null;

        const pongWinMsgs41 = [
            "41çš„ååº”é€Ÿåº¦æ— äººèƒ½æ•Œï¼",
            "å–µå–µæ¥ä¸ä½å‘¢~",
            "è¿™å°±æ˜¯å®åŠ›ï¼",
            "ä¸Šæ–¹å°±æ˜¯æœ€å¼ºçš„ï¼"
        ];
        
        const pongWinMsgsSunflower = [
            "å°å‘æ—¥è‘µå–µçš„å¼¹çƒæœ€å‰å®³ï¼",
            "41è·Ÿä¸ä¸Šæˆ‘çš„é€Ÿåº¦ï¼å–µ~",
            "ä¸‹æ–¹èµ›é«˜ï¼",
            "å–µå–µæ‹³Â·å¼¹çƒç‰ˆï¼"
        ];

        function selectBallCount(count) {
            pongBallCount = count;
            document.querySelectorAll('.ball-count-btn').forEach(btn => {
                if (parseInt(btn.dataset.count) === count) {
                    btn.classList.add('bg-purple-600');
                    btn.classList.remove('bg-purple-600/50');
                    btn.classList.add('border-yellow-400');
                } else {
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-purple-600/50');
                    btn.classList.remove('border-yellow-400');
                }
            });
        }

        function startPongGame() {
            document.getElementById('pong-setup').classList.add('hidden');
            document.getElementById('pong-game').classList.remove('hidden');
            
            pongCanvas = document.getElementById('pong-canvas');
            pongCtx = pongCanvas.getContext('2d');
            
            resizePongCanvas();
            window.addEventListener('resize', resizePongCanvas);
            
            pongState = {
                score1: 0,
                score2: 0,
                roundScore1: 0,
                roundScore2: 0,
                currentRound: 1,
                maxRounds: 3,
                pointsToWin: 5,
                balls: [],
                particles: [],
                trails: []
            };
            
            resetPongRound();
            setupPongControls();
            pongPaused = false;
            pongLoop();
        }

        function resizePongCanvas() {
            pongCanvas.width = window.innerWidth;
            pongCanvas.height = window.innerHeight;
            paddle1X = pongCanvas.width / 2 - paddleWidth / 2;
            paddle2X = pongCanvas.width / 2 - paddleWidth / 2;
        }

        function resetPongRound() {
            pongState.score1 = 0;
            pongState.score2 = 0;
            pongState.balls = [];
            pongState.particles = [];
            pongState.trails = [];
            
            for (let i = 0; i < pongBallCount; i++) {
                setTimeout(() => {
                    if (pongState.balls.length < pongBallCount) {
                        pongState.balls.push(createBall(i));
                    }
                }, i * 600);
            }
            
            updatePongScoreDisplay();
        }

        function createBall(index = 0) {
            const angle = (Math.random() - 0.5) * Math.PI / 4;
            const direction = index % 2 === 0 ? 1 : -1;
            const speed = pongBallCount === 1 ? 6 : (pongBallCount === 2 ? 5 : 4.5);
            
            return {
                x: pongCanvas.width / 2 + (index - pongBallCount / 2 + 0.5) * 60,
                y: pongCanvas.height / 2,
                vx: Math.sin(angle) * speed,
                vy: Math.cos(angle) * speed * direction,
                radius: ballRadius,
                hue: 30 + index * 60,
                speed: speed,
                cooldown: 0
            };
        }

        function setupPongControls() {
            pongCanvas.addEventListener('touchstart', handlePongTouch, { passive: false });
            pongCanvas.addEventListener('touchmove', handlePongTouch, { passive: false });
            pongCanvas.addEventListener('touchend', handlePongTouchEnd, { passive: false });
        }

        function handlePongTouch(e) {
            e.preventDefault();
            for (let touch of e.touches) {
                if (touch.clientY < pongCanvas.height / 2) {
                    touchX1 = touch.clientX;
                } else {
                    touchX2 = touch.clientX;
                }
            }
        }

        function handlePongTouchEnd(e) {
            let hasTop = false, hasBottom = false;
            for (let touch of e.touches) {
                if (touch.clientY < pongCanvas.height / 2) hasTop = true;
                else hasBottom = true;
            }
            if (!hasTop) touchX1 = null;
            if (!hasBottom) touchX2 = null;
        }

        function pongLoop() {
            if (pongPaused) {
                pongAnimationId = requestAnimationFrame(pongLoop);
                return;
            }
            
            updatePong();
            renderPong();
            pongAnimationId = requestAnimationFrame(pongLoop);
        }

        function updatePong() {
            if (touchX1 !== null) {
                const targetX = touchX1 - paddleWidth / 2;
                paddle1X += (targetX - paddle1X) * 0.2;
            }
            if (touchX2 !== null) {
                const targetX = touchX2 - paddleWidth / 2;
                paddle2X += (targetX - paddle2X) * 0.2;
            }
            
            paddle1X = Math.max(10, Math.min(pongCanvas.width - paddleWidth - 10, paddle1X));
            paddle2X = Math.max(10, Math.min(pongCanvas.width - paddleWidth - 10, paddle2X));
            
            const paddle1Y = 100;
            const paddle2Y = pongCanvas.height - 100 - paddleHeight;
            
            for (let ball of pongState.balls) {
                if (ball.cooldown && ball.cooldown > 0) {
                    ball.cooldown--;
                    continue;
                }
                
                pongState.trails.push({
                    x: ball.x,
                    y: ball.y,
                    radius: ball.radius,
                    hue: ball.hue,
                    alpha: 1
                });
                
                ball.x += ball.vx;
                ball.y += ball.vy;
                
                if (ball.x - ball.radius < 0) {
                    ball.x = ball.radius;
                    ball.vx = Math.abs(ball.vx);
                    playWallHit();
                    createParticles(ball.x, ball.y, ball.hue, 5);
                } else if (ball.x + ball.radius > pongCanvas.width) {
                    ball.x = pongCanvas.width - ball.radius;
                    ball.vx = -Math.abs(ball.vx);
                    playWallHit();
                    createParticles(ball.x, ball.y, ball.hue, 5);
                }
                
                if (ball.vy < 0 &&
                    ball.y - ball.radius <= paddle1Y + paddleHeight && 
                    ball.y + ball.radius >= paddle1Y &&
                    ball.x >= paddle1X && ball.x <= paddle1X + paddleWidth) {
                    
                    const hitPos = (ball.x - paddle1X) / paddleWidth - 0.5;
                    const maxAngle = Math.PI / 3;
                    const angle = hitPos * maxAngle;
                    
                    ball.vx = Math.sin(angle) * ball.speed;
                    ball.vy = Math.cos(angle) * ball.speed;
                    
                    ball.y = paddle1Y + paddleHeight + ball.radius + 1;
                    playPaddleHit();
                    createParticles(ball.x, ball.y, 170, 10);
                }
                
                if (ball.vy > 0 &&
                    ball.y + ball.radius >= paddle2Y && 
                    ball.y - ball.radius <= paddle2Y + paddleHeight &&
                    ball.x >= paddle2X && ball.x <= paddle2X + paddleWidth) {
                    
                    const hitPos = (ball.x - paddle2X) / paddleWidth - 0.5;
                    const maxAngle = Math.PI / 3;
                    const angle = hitPos * maxAngle;
                    
                    ball.vx = Math.sin(angle) * ball.speed;
                    ball.vy = -Math.cos(angle) * ball.speed;
                    
                    ball.y = paddle2Y - ball.radius - 1;
                    playPaddleHit();
                    createParticles(ball.x, ball.y, 200, 10);
                }
                
                if (ball.y < -ball.radius * 2) {
                    pongState.score2++;
                    playScoreSound(false);
                    createParticles(pongCanvas.width / 2, 50, 200, 30);
                    resetBall(ball, 1);
                    shakeScreen();
                    checkRoundEnd();
                } else if (ball.y > pongCanvas.height + ball.radius * 2) {
                    pongState.score1++;
                    playScoreSound(true);
                    createParticles(pongCanvas.width / 2, pongCanvas.height - 50, 170, 30);
                    resetBall(ball, -1);
                    shakeScreen();
                    checkRoundEnd();
                }
            }
            
            pongState.particles = pongState.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.02;
                p.size *= 0.98;
                return p.alpha > 0;
            });
            
            pongState.trails = pongState.trails.filter(t => {
                t.alpha -= 0.1;
                t.radius *= 0.9;
                return t.alpha > 0;
            });
            
            updatePongScoreDisplay();
        }

        function resetBall(ball, direction) {
            ball.x = pongCanvas.width / 2 + (Math.random() - 0.5) * 100;
            ball.y = pongCanvas.height / 2;
            const angle = (Math.random() - 0.5) * Math.PI / 5;
            ball.vx = Math.sin(angle) * ball.speed;
            ball.vy = Math.cos(angle) * ball.speed * direction;
            ball.cooldown = 30;
        }

        function createParticles(x, y, hue, count) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                pongState.particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    hue,
                    alpha: 1,
                    size: Math.random() * 5 + 3
                });
            }
        }

        function shakeScreen() {
            const gameEl = document.getElementById('pong-game');
            gameEl.classList.add('screen-shake');
            setTimeout(() => gameEl.classList.remove('screen-shake'), 300);
        }

        function renderPong() {
            const ctx = pongCtx;
            const w = pongCanvas.width;
            const h = pongCanvas.height;
            
            const paddle1Y = 100;
            const paddle2Y = h - 100 - paddleHeight;
            
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#0a2520');
            gradient.addColorStop(0.5, '#1a1a2e');
            gradient.addColorStop(1, '#0a1a28');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
            
            ctx.setLineDash([10, 10]);
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();
            ctx.setLineDash([]);
            
            for (let trail of pongState.trails) {
                ctx.beginPath();
                ctx.arc(trail.x, trail.y, trail.radius, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${trail.hue}, 100%, 60%, ${trail.alpha * 0.5})`;
                ctx.fill();
            }
            
            for (let p of pongState.particles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${p.alpha})`;
                ctx.fill();
            }
            
            ctx.shadowBlur = 25;
            ctx.shadowColor = '#14b8a6';
            ctx.fillStyle = '#14b8a6';
            ctx.beginPath();
            ctx.roundRect(paddle1X, paddle1Y, paddleWidth, paddleHeight, 8);
            ctx.fill();
            
            ctx.shadowColor = '#0ea5e9';
            ctx.fillStyle = '#0ea5e9';
            ctx.beginPath();
            ctx.roundRect(paddle2X, paddle2Y, paddleWidth, paddleHeight, 8);
            ctx.fill();
            
            ctx.shadowBlur = 0;
            
            for (let ball of pongState.balls) {
                const ballGradient = ctx.createRadialGradient(ball.x, ball.y, 0, ball.x, ball.y, ball.radius * 2.5);
                ballGradient.addColorStop(0, `hsla(${ball.hue}, 100%, 70%, 1)`);
                ballGradient.addColorStop(0.4, `hsla(${ball.hue}, 100%, 60%, 0.6)`);
                ballGradient.addColorStop(1, `hsla(${ball.hue}, 100%, 50%, 0)`);
                
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius * 2.5, 0, Math.PI * 2);
                ctx.fillStyle = ballGradient;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${ball.hue}, 100%, 85%)`;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(ball.x - ball.radius * 0.3, ball.y - ball.radius * 0.3, ball.radius * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fill();
            }
            
            ctx.fillStyle = 'rgba(20, 184, 166, 0.03)';
            ctx.fillRect(0, 0, w, h / 2);
            ctx.fillStyle = 'rgba(14, 165, 233, 0.03)';
            ctx.fillRect(0, h / 2, w, h / 2);
            
            ctx.font = '14px sans-serif';
            ctx.fillStyle = 'rgba(20, 184, 166, 0.3)';
            ctx.textAlign = 'center';
            ctx.fillText('â† 41 çš„åŒºåŸŸ â†’', w / 2, 50);
            
            ctx.fillStyle = 'rgba(14, 165, 233, 0.3)';
            ctx.fillText('â† å°å‘æ—¥è‘µå–µ çš„åŒºåŸŸ â†’', w / 2, h - 35);
        }

        function updatePongScoreDisplay() {
            document.getElementById('pong-score-1').textContent = pongState.score1;
            document.getElementById('pong-score-2').textContent = pongState.score2;
            document.getElementById('pong-round').textContent = pongState.currentRound;
            document.getElementById('round-score-1').textContent = pongState.roundScore1;
            document.getElementById('round-score-2').textContent = pongState.roundScore2;
        }

        function checkRoundEnd() {
            if (pongState.score1 >= pongState.pointsToWin || pongState.score2 >= pongState.pointsToWin) {
                pongPaused = true;
                
                const winner = pongState.score1 >= pongState.pointsToWin ? 1 : 2;
                if (winner === 1) pongState.roundScore1++;
                else pongState.roundScore2++;
                
                const matchWinner = checkMatchEnd();
                
                setTimeout(() => {
                    showPongEndModal(winner, matchWinner);
                }, 500);
            }
        }

        function checkMatchEnd() {
            const winsNeeded = Math.ceil(pongState.maxRounds / 2);
            if (pongState.roundScore1 >= winsNeeded) return 1;
            if (pongState.roundScore2 >= winsNeeded) return 2;
            return null;
        }

        function showPongEndModal(roundWinner, matchWinner) {
            playRoundWinSound();
            
            const modal = document.getElementById('pong-end-modal');
            const icon = document.getElementById('pong-end-icon');
            const title = document.getElementById('pong-end-title');
            const msg = document.getElementById('pong-end-msg');
            const buttons = document.getElementById('pong-end-buttons');
            
            modal.classList.remove('hidden');
            
            if (matchWinner) {
                icon.textContent = 'ğŸ†';
                if (matchWinner === 1) {
                    title.innerHTML = '<span class="text-teal-400">41</span> è·å¾—æ€»å† å†›!';
                    msg.textContent = pongWinMsgs41[Math.floor(Math.random() * pongWinMsgs41.length)];
                } else {
                    title.innerHTML = '<span class="text-sky-400">å°å‘æ—¥è‘µå–µ</span> è·å¾—æ€»å† å†›!';
                    msg.textContent = pongWinMsgsSunflower[Math.floor(Math.random() * pongWinMsgsSunflower.length)];
                }
                buttons.innerHTML = `
                    <button onclick="restartPong()" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold">
                        å†æ¥ä¸€åœº
                    </button>
                    <button onclick="exitPong()" class="w-full py-3 rounded-xl bg-gray-600 text-white font-bold">
                        è¿”å›ä¸»é¡µ
                    </button>
                `;
            } else {
                icon.textContent = roundWinner === 1 ? 'ğŸƒ' : 'ğŸŒ»';
                title.innerHTML = `ç¬¬ ${pongState.currentRound} å±€: <span class="${roundWinner === 1 ? 'text-teal-400' : 'text-sky-400'}">${roundWinner === 1 ? '41' : 'å°å‘æ—¥è‘µå–µ'}</span> è·èƒœ!`;
                msg.textContent = `å½“å‰æ¯”åˆ† ${pongState.roundScore1} : ${pongState.roundScore2}`;
                buttons.innerHTML = `
                    <button onclick="nextPongRound()" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-500 to-sky-500 text-white font-bold">
                        ä¸‹ä¸€å±€
                    </button>
                `;
            }
        }

        function nextPongRound() {
            document.getElementById('pong-end-modal').classList.add('hidden');
            pongState.currentRound++;
            resetPongRound();
            pongPaused = false;
        }

        function pausePong() {
            pongPaused = true;
            document.getElementById('pong-pause-modal').classList.remove('hidden');
        }

        function resumePong() {
            document.getElementById('pong-pause-modal').classList.add('hidden');
            pongPaused = false;
        }

        function restartPong() {
            document.getElementById('pong-pause-modal').classList.add('hidden');
            document.getElementById('pong-end-modal').classList.add('hidden');
            
            pongState.roundScore1 = 0;
            pongState.roundScore2 = 0;
            pongState.currentRound = 1;
            resetPongRound();
            pongPaused = false;
        }

        function exitPong() {
            document.getElementById('pong-pause-modal').classList.add('hidden');
            document.getElementById('pong-end-modal').classList.add('hidden');
            
            if (pongAnimationId) {
                cancelAnimationFrame(pongAnimationId);
                pongAnimationId = null;
            }
            
            document.getElementById('pong-game').classList.add('hidden');
            document.getElementById('pong-setup').classList.remove('hidden');
            backToMenu();
        }

        // ==================== TAROT SYSTEM ====================
        
        // Major Arcana Cards (22 cards)
        const tarotCards = [
            { id: 0, name: "æ„šè€…", emoji: "ğŸƒ", meaning: "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸã€è‡ªç”±", reverseMeaning: "é²è½ã€å†’å¤±ã€ä¸è®¡åæœ", keywords: ["å¼€å§‹", "å†’é™©", "å¤©çœŸ"] },
            { id: 1, name: "é­”æœ¯å¸ˆ", emoji: "ğŸ©", meaning: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›ã€è‡ªä¿¡", reverseMeaning: "æ¬ºéª—ã€æŠ€èƒ½ä¸è¶³ã€çŠ¹è±«ä¸å†³", keywords: ["åˆ›é€ ", "è¡ŒåŠ¨", "èƒ½åŠ›"] },
            { id: 2, name: "å¥³ç¥­å¸", emoji: "ğŸŒ™", meaning: "ç›´è§‰ã€ç¥ç§˜ã€å†…åœ¨æ™ºæ…§ã€æ½œæ„è¯†", reverseMeaning: "éšè—çš„çœŸç›¸ã€å¿½è§†ç›´è§‰", keywords: ["ç›´è§‰", "ç¥ç§˜", "æ™ºæ…§"] },
            { id: 3, name: "å¥³çš‡", emoji: "ğŸ‘‘", meaning: "ä¸°æ”¶ã€æ¯æ€§ã€è‡ªç„¶ã€å¯Œè¶³", reverseMeaning: "ä¾èµ–ã€åˆ›é€ åŠ›å—é˜»ã€ç©ºè™š", keywords: ["ä¸°æ”¶", "æ»‹å…»", "ç¾ä¸½"] },
            { id: 4, name: "çš‡å¸", emoji: "ğŸ¦", meaning: "æƒå¨ã€ç»“æ„ã€æ§åˆ¶ã€çˆ¶äº²å½¢è±¡", reverseMeaning: "ä¸“åˆ¶ã€ç¼ºä¹è‡ªå¾‹ã€è½¯å¼±", keywords: ["æƒå¨", "ç¨³å®š", "æ§åˆ¶"] },
            { id: 5, name: "æ•™çš‡", emoji: "â›ª", meaning: "ä¼ ç»Ÿã€ä¿¡ä»°ã€æ•™è‚²ã€ç²¾ç¥æŒ‡å¼•", reverseMeaning: "æ‰“ç ´å¸¸è§„ã€ä¸ªäººä¿¡å¿µ", keywords: ["ä¿¡ä»°", "ä¼ ç»Ÿ", "æŒ‡å¼•"] },
            { id: 6, name: "æ‹äºº", emoji: "ğŸ’•", meaning: "çˆ±æƒ…ã€å’Œè°ã€é€‰æ‹©ã€å…³ç³»", reverseMeaning: "ä¸å’Œè°ã€ä»·å€¼è§‚å†²çªã€é”™è¯¯é€‰æ‹©", keywords: ["çˆ±æƒ…", "é€‰æ‹©", "å’Œè°"] },
            { id: 7, name: "æˆ˜è½¦", emoji: "âš”ï¸", meaning: "èƒœåˆ©ã€æ„å¿—åŠ›ã€å†³å¿ƒã€è¡ŒåŠ¨", reverseMeaning: "å¤±è´¥ã€ç¼ºä¹æ–¹å‘ã€å¤±æ§", keywords: ["èƒœåˆ©", "å‰è¿›", "å†³å¿ƒ"] },
            { id: 8, name: "åŠ›é‡", emoji: "ğŸ¦‹", meaning: "å‹‡æ°”ã€è€å¿ƒã€å†…åœ¨åŠ›é‡ã€æ…ˆæ‚²", reverseMeaning: "è‡ªæˆ‘æ€€ç–‘ã€è½¯å¼±ã€ç¼ºä¹è‡ªä¿¡", keywords: ["å‹‡æ°”", "åŠ›é‡", "æ¸©æŸ”"] },
            { id: 9, name: "éšå£«", emoji: "ğŸ”ï¸", meaning: "å†…çœã€å¯»æ‰¾çœŸç†ã€ç‹¬å¤„ã€æŒ‡å¼•", reverseMeaning: "å­¤ç«‹ã€é€ƒé¿ã€æ‹’ç»å¸®åŠ©", keywords: ["å†…çœ", "æ™ºæ…§", "ç‹¬å¤„"] },
            { id: 10, name: "å‘½è¿ä¹‹è½®", emoji: "ğŸ¡", meaning: "å˜åŒ–ã€å‘¨æœŸã€å‘½è¿ã€è½¬æŠ˜ç‚¹", reverseMeaning: "åè¿æ°”ã€æŠ—æ‹’æ”¹å˜ã€å¤±æ§", keywords: ["å˜åŒ–", "å‘½è¿", "è½¬æœº"] },
            { id: 11, name: "æ­£ä¹‰", emoji: "âš–ï¸", meaning: "å…¬å¹³ã€çœŸç›¸ã€å› æœã€æ³•å¾‹", reverseMeaning: "ä¸å…¬å¹³ã€é€ƒé¿è´£ä»»ã€æ¬ºéª—", keywords: ["å…¬æ­£", "çœŸç›¸", "å¹³è¡¡"] },
            { id: 12, name: "å€’åŠäºº", emoji: "ğŸ™ƒ", meaning: "ç‰ºç‰²ã€æ–°è§†è§’ã€ç­‰å¾…ã€æ”¾æ‰‹", reverseMeaning: "æ‹–å»¶ã€æŠ—æ‹’ç‰ºç‰²ã€å¾’åŠ³", keywords: ["ç‰ºç‰²", "ç­‰å¾…", "æ–°è§†è§’"] },
            { id: 13, name: "æ­»ç¥", emoji: "ğŸ¦‹", meaning: "ç»“æŸã€è½¬å˜ã€æ–°ç”Ÿã€æ”¾ä¸‹è¿‡å»", reverseMeaning: "æŠ—æ‹’æ”¹å˜ã€ææƒ§ã€åœæ»", keywords: ["ç»“æŸ", "è½¬å˜", "é‡ç”Ÿ"] },
            { id: 14, name: "èŠ‚åˆ¶", emoji: "ğŸŒˆ", meaning: "å¹³è¡¡ã€è€å¿ƒã€è°ƒå’Œã€ä¸­åº¸", reverseMeaning: "å¤±è¡¡ã€è¿‡åº¦ã€ç¼ºä¹è¿œè§", keywords: ["å¹³è¡¡", "è€å¿ƒ", "å’Œè°"] },
            { id: 15, name: "æ¶é­”", emoji: "â›“ï¸", meaning: "æŸç¼šã€è¯±æƒ‘ã€ç‰©è´¨ä¸»ä¹‰ã€é˜´å½±", reverseMeaning: "è§£æ”¾ã€é¢å¯¹ææƒ§ã€çªç ´é™åˆ¶", keywords: ["æŸç¼š", "è¯±æƒ‘", "é˜´å½±"] },
            { id: 16, name: "å¡”", emoji: "ğŸ—¼", meaning: "çªå˜ã€ç¾éš¾ã€å¯ç¤ºã€è§‰é†’", reverseMeaning: "é€ƒé¿ç¾éš¾ã€ææƒ§æ”¹å˜", keywords: ["çªå˜", "å´©å¡Œ", "è§‰é†’"] },
            { id: 17, name: "æ˜Ÿæ˜Ÿ", emoji: "â­", meaning: "å¸Œæœ›ã€ä¿¡å¿µã€çµæ„Ÿã€å®é™", reverseMeaning: "å¤±æœ›ã€ç¼ºä¹ä¿¡å¿ƒã€ç»æœ›", keywords: ["å¸Œæœ›", "ä¿¡å¿µ", "æ„ˆåˆ"] },
            { id: 18, name: "æœˆäº®", emoji: "ğŸŒ•", meaning: "å¹»è±¡ã€ç›´è§‰ã€ææƒ§ã€æ½œæ„è¯†", reverseMeaning: "é‡Šæ”¾ææƒ§ã€çœŸç›¸å¤§ç™½", keywords: ["å¹»è±¡", "ç›´è§‰", "è¿·æƒ‘"] },
            { id: 19, name: "å¤ªé˜³", emoji: "â˜€ï¸", meaning: "æˆåŠŸã€æ´»åŠ›ã€å¿«ä¹ã€å…‰æ˜", reverseMeaning: "æš‚æ—¶çš„æŒ«æŠ˜ã€è¿‡åº¦ä¹è§‚", keywords: ["æˆåŠŸ", "å¿«ä¹", "æ´»åŠ›"] },
            { id: 20, name: "å®¡åˆ¤", emoji: "ğŸ“¯", meaning: "é‡ç”Ÿã€å†…åœ¨å¬å”¤ã€åæ€ã€å†³æ–­", reverseMeaning: "è‡ªæˆ‘æ€€ç–‘ã€æ‹’ç»åæ€", keywords: ["é‡ç”Ÿ", "è§‰é†’", "è¯„åˆ¤"] },
            { id: 21, name: "ä¸–ç•Œ", emoji: "ğŸŒ", meaning: "å®Œæˆã€æˆå°±ã€åœ†æ»¡ã€æ•´åˆ", reverseMeaning: "æœªå®Œæˆã€ç¼ºä¹æ”¶å°¾", keywords: ["å®Œæˆ", "åœ†æ»¡", "æˆå°±"] }
        ];

        // Spread types
        const spreads = {
            single: { name: "å•ç‰Œå åœ", count: 1, positions: ["æŒ‡å¼•"] },
            three: { name: "æ—¶é—´ä¹‹æµ", count: 3, positions: ["è¿‡å»", "ç°åœ¨", "æœªæ¥"] },
            love: { name: "çˆ±æƒ…å åœ", count: 3, positions: ["ä½ çš„çŠ¶æ€", "å¯¹æ–¹çš„çŠ¶æ€", "å…³ç³»èµ°å‘"] },
            cross: { name: "åå­—ç‰Œé˜µ", count: 5, positions: ["å½“å‰çŠ¶æ€", "æŒ‘æˆ˜", "è¿‡å»å½±å“", "æœªæ¥å¯èƒ½", "å»ºè®®"] }
        };

        let tarotState = {
            question: '',
            selectedSpread: null,
            selectedCards: [],
            drawnCards: [],
            step: 1
        };

        function resetTarot() {
            tarotState = {
                question: '',
                selectedSpread: null,
                selectedCards: [],
                drawnCards: [],
                step: 1
            };
            
            document.getElementById('tarot-question').value = '';
            document.getElementById('start-reading-btn').disabled = true;
            
            document.querySelectorAll('.spread-btn').forEach(btn => {
                btn.classList.remove('border-purple-400', 'border-pink-400', 'border-indigo-400');
            });
            
            document.getElementById('tarot-step-1').classList.remove('hidden');
            document.getElementById('tarot-step-2').classList.add('hidden');
            document.getElementById('tarot-step-3').classList.add('hidden');
        }

        function selectSpread(spreadType) {
            tarotState.selectedSpread = spreadType;
            
            document.querySelectorAll('.spread-btn').forEach(btn => {
                btn.classList.remove('border-purple-400', 'border-pink-400', 'border-indigo-400');
            });
            
            event.currentTarget.classList.add(spreadType === 'love' ? 'border-pink-400' : 'border-purple-400');
            
            checkCanStart();
            playTone(600, 'sine', 0.1, 0.05);
        }

        function checkCanStart() {
            const question = document.getElementById('tarot-question').value.trim();
            const hasSpread = tarotState.selectedSpread !== null;
            
            document.getElementById('start-reading-btn').disabled = !(question.length > 0 && hasSpread);
        }

        document.getElementById('tarot-question').addEventListener('input', checkCanStart);

        function startReading() {
            tarotState.question = document.getElementById('tarot-question').value.trim();
            tarotState.step = 2;
            
            playMysticalSound();
            
            document.getElementById('tarot-step-1').classList.add('hidden');
            document.getElementById('tarot-step-2').classList.remove('hidden');
            
            generateCardDeck();
        }

        function generateCardDeck() {
            const spread = spreads[tarotState.selectedSpread];
            const deck = document.getElementById('card-deck');
            deck.innerHTML = '';
            
            document.getElementById('cards-remaining').textContent = spread.count;
            
            // Shuffle cards
            const shuffled = [...tarotCards].sort(() => Math.random() - 0.5);
            
            // Create card elements
            shuffled.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'tarot-card w-12 h-18 cursor-pointer transition-all duration-300 hover:scale-110 hover:-translate-y-2';
                cardEl.dataset.cardId = card.id;
                cardEl.innerHTML = `
                    <div class="tarot-card-inner w-full h-full relative">
                        <div class="tarot-card-front absolute inset-0 rounded-lg card-back-pattern border-2 border-purple-400/50 flex items-center justify-center">
                            <span class="text-purple-200 text-lg">âœ¨</span>
                        </div>
                    </div>
                `;
                cardEl.style.animationDelay = `${index * 0.02}s`;
                cardEl.onclick = () => selectCard(card.id, cardEl);
                deck.appendChild(cardEl);
            });
            
            updateSelectedPreview();
        }

        function selectCard(cardId, element) {
            const spread = spreads[tarotState.selectedSpread];
            
            if (tarotState.selectedCards.includes(cardId)) {
                // Deselect
                tarotState.selectedCards = tarotState.selectedCards.filter(id => id !== cardId);
                element.classList.remove('ring-4', 'ring-yellow-400', 'scale-110');
            } else if (tarotState.selectedCards.length < spread.count) {
                // Select
                tarotState.selectedCards.push(cardId);
                element.classList.add('ring-4', 'ring-yellow-400', 'scale-110');
                playCardFlipSound();
                
                // Check if all cards selected
                if (tarotState.selectedCards.length === spread.count) {
                    setTimeout(() => revealCards(), 500);
                }
            }
            
            document.getElementById('cards-remaining').textContent = spread.count - tarotState.selectedCards.length;
            updateSelectedPreview();
        }

        function updateSelectedPreview() {
            const preview = document.getElementById('selected-cards-preview');
            const spread = spreads[tarotState.selectedSpread];
            
            preview.innerHTML = '';
            for (let i = 0; i < spread.count; i++) {
                const slotEl = document.createElement('div');
                slotEl.className = 'w-10 h-14 rounded-lg border-2 border-dashed border-purple-500/50 flex items-center justify-center';
                
                if (tarotState.selectedCards[i] !== undefined) {
                    const card = tarotCards.find(c => c.id === tarotState.selectedCards[i]);
                    slotEl.className = 'w-10 h-14 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-lg';
                    slotEl.innerHTML = 'ğŸ”®';
                } else {
                    slotEl.innerHTML = `<span class="text-purple-500/50 text-xs">${i + 1}</span>`;
                }
                
                preview.appendChild(slotEl);
            }
        }

        function revealCards() {
            tarotState.step = 3;
            
            document.getElementById('tarot-step-2').classList.add('hidden');
            document.getElementById('tarot-step-3').classList.remove('hidden');
            
            // Draw cards with potential reversal
            tarotState.drawnCards = tarotState.selectedCards.map(id => {
                const card = tarotCards.find(c => c.id === id);
                const isReversed = Math.random() < 0.3; // 30% chance of reversal
                return { ...card, isReversed };
            });
            
            displayResults();
            playMysticalSound();
        }

        function displayResults() {
            const spread = spreads[tarotState.selectedSpread];
            const resultCards = document.getElementById('result-cards');
            const interpretation = document.getElementById('reading-interpretation');
            
            document.getElementById('result-question').textContent = `ã€Œ${tarotState.question}ã€`;
            
            // Display cards
            resultCards.innerHTML = '';
            tarotState.drawnCards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'text-center animate-[popIn_0.5s_ease-out]';
                cardEl.style.animationDelay = `${index * 0.2}s`;
                cardEl.innerHTML = `
                    <div class="text-purple-400 text-xs mb-1">${spread.positions[index]}</div>
                    <div class="w-20 h-28 rounded-xl bg-gradient-to-br ${card.isReversed ? 'from-gray-700 to-purple-900' : 'from-purple-600 to-indigo-600'} flex flex-col items-center justify-center p-2 purple-glow ${card.isReversed ? 'rotate-180' : ''}">
                        <span class="text-3xl mb-1 ${card.isReversed ? 'rotate-180' : ''}">${card.emoji}</span>
                        <span class="text-white text-xs font-bold ${card.isReversed ? 'rotate-180' : ''}">${card.name}</span>
                    </div>
                    <div class="text-xs mt-1 ${card.isReversed ? 'text-orange-400' : 'text-purple-300'}">
                        ${card.isReversed ? 'é€†ä½' : 'æ­£ä½'}
                    </div>
                `;
                resultCards.appendChild(cardEl);
            });
            
            // Generate interpretation
            interpretation.innerHTML = generateInterpretation();
        }

        function generateInterpretation() {
            const spread = spreads[tarotState.selectedSpread];
            let html = '';
            
            tarotState.drawnCards.forEach((card, index) => {
                const meaning = card.isReversed ? card.reverseMeaning : card.meaning;
                const positionName = spread.positions[index];
                
                html += `
                    <div class="mb-4 pb-4 ${index < tarotState.drawnCards.length - 1 ? 'border-b border-purple-500/30' : ''}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">${card.emoji}</span>
                            <span class="font-bold text-purple-200">${positionName}ï¼š${card.name}</span>
                            <span class="text-xs ${card.isReversed ? 'text-orange-400 bg-orange-400/20' : 'text-green-400 bg-green-400/20'} px-2 py-0.5 rounded">
                                ${card.isReversed ? 'é€†ä½' : 'æ­£ä½'}
                            </span>
                        </div>
                        <p class="text-purple-300 text-sm leading-relaxed">${meaning}</p>
                        <div class="flex gap-2 mt-2">
                            ${card.keywords.map(k => `<span class="text-xs bg-purple-500/30 text-purple-200 px-2 py-0.5 rounded-full">${k}</span>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            // Add overall summary
            html += `
                <div class="mt-4 pt-4 border-t border-purple-500/30">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ğŸ”®</span>
                        <span class="font-bold gold-text">ç»¼åˆè§£è¯»</span>
                    </div>
                    <p class="text-purple-200 text-sm leading-relaxed">
                        ${generateSummary()}
                    </p>
                </div>
            `;
            
            return html;
        }

        function generateSummary() {
            const cards = tarotState.drawnCards;
            const positiveCards = cards.filter(c => !c.isReversed).length;
            const totalCards = cards.length;
            
            const summaries = {
                veryPositive: [
                    "æ•´ä½“æ¥çœ‹ï¼Œå®‡å®™æ­£åœ¨å‘ä½ ä¼ é€’ç§¯æçš„èƒ½é‡ã€‚è¿™æ˜¯ä¸€ä¸ªå……æ»¡å¸Œæœ›å’Œæœºé‡çš„æ—¶æœŸï¼ŒæŠ“ä½çœ¼å‰çš„æœºä¼šï¼Œç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ã€‚âœ¨",
                    "å‘½è¿ä¹‹è½®æ­£åœ¨æœç€æœ‰åˆ©çš„æ–¹å‘è½¬åŠ¨ã€‚ä¿æŒç§¯æçš„å¿ƒæ€ï¼Œå¥½è¿æ­£åœ¨å‘ä½ é è¿‘ã€‚ä½ çš„åŠªåŠ›å°†ä¼šå¾—åˆ°å›æŠ¥ã€‚ğŸŒŸ",
                    "æ˜Ÿè±¡æ˜¾ç¤ºè¿™æ˜¯ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„æ—¶åˆ»ã€‚æ”¾å¼€æŸç¼šï¼Œå¤§èƒ†å‰è¡Œï¼Œä½ å°†æ”¶è·æ„æƒ³ä¸åˆ°çš„æƒŠå–œã€‚ğŸ’«"
                ],
                positive: [
                    "æ•´ä½“è¶‹åŠ¿å‘å¥½ï¼Œä½†ä»éœ€ä¿æŒè­¦æƒ•ã€‚ç›¸ä¿¡è‡ªå·±çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿè¦æ³¨æ„èº«è¾¹çš„æç¤ºå’Œä¿¡å·ã€‚å¹³è¡¡æ˜¯å…³é”®ã€‚ğŸŒ™",
                    "ä½ æ­£èµ°åœ¨æ­£ç¡®çš„é“è·¯ä¸Šï¼Œè™½ç„¶å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å°æŒ‘æˆ˜ï¼Œä½†è¿™äº›éƒ½æ˜¯æˆé•¿çš„æœºä¼šã€‚ä¿æŒåˆå¿ƒï¼Œç»§ç»­å‰è¿›ã€‚â­",
                    "å®‡å®™é¼“åŠ±ä½ ä¿æŒä¿¡å¿µï¼Œå³ä½¿é¢ä¸´å›°éš¾ä¹Ÿä¸è¦æ”¾å¼ƒã€‚ä½ å†…å¿ƒçš„åŠ›é‡æ¯”ä½ æƒ³è±¡çš„æ›´å¼ºå¤§ã€‚ğŸ’ª"
                ],
                mixed: [
                    "è¿™æ˜¯ä¸€ä¸ªè½¬å˜çš„æ—¶æœŸï¼Œéœ€è¦ä½ é‡æ–°å®¡è§†å½“å‰çš„å¤„å¢ƒã€‚æœ‰äº›äº‹æƒ…éœ€è¦æ”¾ä¸‹ï¼Œæ‰èƒ½è¿æ¥æ–°çš„å¼€å§‹ã€‚ä¿æŒå¼€æ”¾çš„å¿ƒæ€ã€‚ğŸŒˆ",
                    "å…‰æ˜ä¸é˜´å½±å¹¶å­˜ï¼Œè¿™æ­£æ˜¯ç”Ÿå‘½çš„æœ¬è´¨ã€‚æ¥å—ä¸å®Œç¾ï¼Œä»æŒ‘æˆ˜ä¸­å­¦ä¹ ï¼Œä½ å°†å˜å¾—æ›´åŠ å¼ºå¤§ã€‚ğŸ¦‹",
                    "å®‡å®™æ­£åœ¨é‚€è¯·ä½ è¿›è¡Œå†…åœ¨çš„æ¢ç´¢ã€‚å€¾å¬å†…å¿ƒçš„å£°éŸ³ï¼Œç­”æ¡ˆå°±åœ¨ä½ çš„å¿ƒä¸­ã€‚é™ä¸‹æ¥ï¼Œä½ ä¼šæ‰¾åˆ°æ–¹å‘ã€‚ğŸ”®"
                ],
                challenging: [
                    "çœ¼å‰å¯èƒ½ä¼šæœ‰äº›æŒ‘æˆ˜ï¼Œä½†è¯·è®°ä½ï¼Œè¿™æ˜¯æˆé•¿çš„å¿…ç»ä¹‹è·¯ã€‚æ¯ä¸€æ¬¡å›°éš¾éƒ½æ˜¯èœ•å˜çš„æœºä¼šã€‚ç›¸ä¿¡è¿‡ç¨‹ã€‚ğŸŒ±",
                    "ç°åœ¨å¯èƒ½ä¸æ˜¯æœ€é¡ºåˆ©çš„æ—¶æœŸï¼Œä½†è¿™æ°æ°æ˜¯åæ€å’Œè°ƒæ•´çš„å¥½æ—¶æœºã€‚é€€ä¸€æ­¥ï¼Œé‡æ–°è§„åˆ’ä½ çš„é“è·¯ã€‚ğŸŒ™",
                    "å®‡å®™ä¼¼ä¹åœ¨æé†’ä½ éœ€è¦åšå‡ºä¸€äº›æ”¹å˜ã€‚æ”¾ä¸‹ä¸å†æœåŠ¡äºä½ çš„ä¸œè¥¿ï¼Œä¸ºæ–°çš„å¯èƒ½æ€§è…¾å‡ºç©ºé—´ã€‚âœ¨"
                ]
            };
            
            let category;
            const ratio = positiveCards / totalCards;
            
            if (ratio >= 0.8) category = 'veryPositive';
            else if (ratio >= 0.5) category = 'positive';
            else if (ratio >= 0.3) category = 'mixed';
            else category = 'challenging';
            
            const options = summaries[category];
            return options[Math.floor(Math.random() * options.length)];
        }

        // ==================== TERRITORY GAME ====================
        let territoryCanvas, territoryCtx;
        let territoryAnimationId = null;
        let territoryTimerId = null;
        let territoryDuration = 30;
        let territoryPaused = false;
        let territoryControlsSetup = false;
        
        const GRID_COLS = 10;
        const GRID_ROWS = 12;
        
        let territoryState = {
            timeLeft: 30,
            grid: [],
            balls: [],
            particles: [],
            paddle1X: 0,
            paddle2X: 0,
            score1: 0,
            score2: 0
        };
        
        let terTouchX1 = null, terTouchX2 = null;
        
        const territoryWinMsgs41 = [
            "41çš„åœ°ç›˜æœ€å¤§ï¼",
            "é’ç»¿è‰²ç§°éœ¸å…¨åœºï¼",
            "å°å‘æ—¥è‘µå–µçš„åœ°ç›˜è¢«æˆ‘æŠ¢å…‰å•¦~",
            "è¿™å°±æ˜¯é¢†åœŸæ‰©å¼ çš„è‰ºæœ¯ï¼"
        ];
        
        const territoryWinMsgsSunflower = [
            "å°å‘æ—¥è‘µå–µå é¢†æˆåŠŸï¼å–µ~",
            "æ·¡è“è‰²çš„ç‰ˆå›¾æ— è¾¹æ— é™…ï¼",
            "41çš„åœ°ç›˜éƒ½æ˜¯æˆ‘çš„å•¦ï¼",
            "å–µå–µæ‹³Â·åœˆåœ°ç‰ˆï¼"
        ];
        
        const territoryDrawMsgs = [
            "åŠ¿å‡åŠ›æ•Œï¼ä¸‹æ¬¡å†æˆ˜ï¼",
            "å¹³å±€ï¼ä½ ä»¬å¤ªå‰å®³äº†ï¼",
            "ä¸åˆ†èƒœè´Ÿï¼çœŸæ˜¯æ£‹é€¢å¯¹æ‰‹ï¼"
        ];

        function selectDuration(duration) {
            territoryDuration = duration;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                if (parseInt(btn.dataset.duration) === duration) {
                    btn.classList.add('bg-emerald-600');
                    btn.classList.remove('bg-emerald-600/50');
                    btn.classList.add('border-yellow-400');
                } else {
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-emerald-600/50');
                    btn.classList.remove('border-yellow-400');
                }
            });
        }

        function startTerritoryGame() {
            document.getElementById('territory-setup').classList.add('hidden');
            document.getElementById('territory-game').classList.remove('hidden');
            
            territoryCanvas = document.getElementById('territory-canvas');
            territoryCtx = territoryCanvas.getContext('2d');
            
            resizeTerritoryCanvas();
            window.addEventListener('resize', resizeTerritoryCanvas);
            
            initTerritoryGame();
            setupTerritoryControls();
            territoryPaused = false;
            
            // Start timer
            territoryTimerId = setInterval(() => {
                if (!territoryPaused && territoryState.timeLeft > 0) {
                    territoryState.timeLeft--;
                    document.getElementById('territory-timer').textContent = territoryState.timeLeft;
                    
                    if (territoryState.timeLeft <= 0) {
                        endTerritoryGame();
                    }
                }
            }, 1000);
            
            territoryLoop();
        }

        function resizeTerritoryCanvas() {
            territoryCanvas.width = window.innerWidth;
            territoryCanvas.height = window.innerHeight;
        }

        function initTerritoryGame() {
            const w = territoryCanvas.width;
            const paddleWidth = 120;
            
            territoryState = {
                timeLeft: territoryDuration,
                grid: [],
                balls: [],
                particles: [],
                paddle1X: w / 2 - paddleWidth / 2,
                paddle2X: w / 2 - paddleWidth / 2,
                score1: 0,
                score2: 0
            };
            
            document.getElementById('territory-timer').textContent = territoryDuration;
            
            // Initialize grid - all neutral
            for (let row = 0; row < GRID_ROWS; row++) {
                territoryState.grid[row] = [];
                for (let col = 0; col < GRID_COLS; col++) {
                    territoryState.grid[row][col] = {
                        owner: 0, // 0 = neutral, 1 = player1, 2 = player2
                        flash: 0
                    };
                }
            }
            
            // Create two balls
            territoryState.balls = [
                createTerritoryBall(1),
                createTerritoryBall(2)
            ];
            
            updateTerritoryScore();
        }

        function createTerritoryBall(player) {
            const w = territoryCanvas.width;
            const h = territoryCanvas.height;
            const speed = 5;
            const angle = (Math.random() - 0.5) * Math.PI / 3;
            
            return {
                x: w / 2 + (player === 1 ? -50 : 50),
                y: player === 1 ? 150 : h - 150,
                vx: Math.sin(angle) * speed,
                vy: (player === 1 ? 1 : -1) * Math.cos(angle) * speed,
                radius: 10,
                player: player,
                speed: speed
            };
        }

        function setupTerritoryControls() {
            if (territoryControlsSetup) return;
            territoryControlsSetup = true;
            
            territoryCanvas.addEventListener('touchstart', handleTerritoryTouch, { passive: false });
            territoryCanvas.addEventListener('touchmove', handleTerritoryTouch, { passive: false });
            territoryCanvas.addEventListener('touchend', handleTerritoryTouchEnd, { passive: false });
        }

        function handleTerritoryTouch(e) {
            e.preventDefault();
            for (let touch of e.touches) {
                if (touch.clientY < territoryCanvas.height / 2) {
                    terTouchX1 = touch.clientX;
                } else {
                    terTouchX2 = touch.clientX;
                }
            }
        }

        function handleTerritoryTouchEnd(e) {
            let hasTop = false, hasBottom = false;
            for (let touch of e.touches) {
                if (touch.clientY < territoryCanvas.height / 2) hasTop = true;
                else hasBottom = true;
            }
            if (!hasTop) terTouchX1 = null;
            if (!hasBottom) terTouchX2 = null;
        }

        function territoryLoop() {
            if (territoryPaused) {
                territoryAnimationId = requestAnimationFrame(territoryLoop);
                return;
            }
            
            updateTerritory();
            renderTerritory();
            territoryAnimationId = requestAnimationFrame(territoryLoop);
        }

        function updateTerritory() {
            const w = territoryCanvas.width;
            const h = territoryCanvas.height;
            const paddleWidth = 120;
            const paddleHeight = 15;
            const paddle1Y = 100;
            const paddle2Y = h - 100 - paddleHeight;
            
            // Update paddles
            if (terTouchX1 !== null) {
                const targetX = terTouchX1 - paddleWidth / 2;
                territoryState.paddle1X += (targetX - territoryState.paddle1X) * 0.2;
            }
            if (terTouchX2 !== null) {
                const targetX = terTouchX2 - paddleWidth / 2;
                territoryState.paddle2X += (targetX - territoryState.paddle2X) * 0.2;
            }
            
            territoryState.paddle1X = Math.max(10, Math.min(w - paddleWidth - 10, territoryState.paddle1X));
            territoryState.paddle2X = Math.max(10, Math.min(w - paddleWidth - 10, territoryState.paddle2X));
            
            // Calculate grid area
            const gridTop = 130;
            const gridBottom = h - 130;
            const gridHeight = gridBottom - gridTop;
            const cellWidth = w / GRID_COLS;
            const cellHeight = gridHeight / GRID_ROWS;
            
            // Update balls
            for (let ball of territoryState.balls) {
                ball.x += ball.vx;
                ball.y += ball.vy;
                
                // Wall collision
                if (ball.x - ball.radius < 0) {
                    ball.x = ball.radius;
                    ball.vx = Math.abs(ball.vx);
                    playWallHit();
                } else if (ball.x + ball.radius > w) {
                    ball.x = w - ball.radius;
                    ball.vx = -Math.abs(ball.vx);
                    playWallHit();
                }
                
                // Paddle 1 collision (top)
                if (ball.vy < 0 &&
                    ball.y - ball.radius <= paddle1Y + paddleHeight &&
                    ball.y + ball.radius >= paddle1Y &&
                    ball.x >= territoryState.paddle1X &&
                    ball.x <= territoryState.paddle1X + paddleWidth) {
                    
                    const hitPos = (ball.x - territoryState.paddle1X) / paddleWidth - 0.5;
                    const angle = hitPos * Math.PI / 3;
                    ball.vx = Math.sin(angle) * ball.speed;
                    ball.vy = Math.cos(angle) * ball.speed;
                    ball.y = paddle1Y + paddleHeight + ball.radius + 1;
                    playPaddleHit();
                    createTerritoryParticles(ball.x, ball.y, ball.player === 1 ? 170 : 200, 8);
                }
                
                // Paddle 2 collision (bottom)
                if (ball.vy > 0 &&
                    ball.y + ball.radius >= paddle2Y &&
                    ball.y - ball.radius <= paddle2Y + paddleHeight &&
                    ball.x >= territoryState.paddle2X &&
                    ball.x <= territoryState.paddle2X + paddleWidth) {
                    
                    const hitPos = (ball.x - territoryState.paddle2X) / paddleWidth - 0.5;
                    const angle = hitPos * Math.PI / 3;
                    ball.vx = Math.sin(angle) * ball.speed;
                    ball.vy = -Math.cos(angle) * ball.speed;
                    ball.y = paddle2Y - ball.radius - 1;
                    playPaddleHit();
                    createTerritoryParticles(ball.x, ball.y, ball.player === 1 ? 170 : 200, 8);
                }
                
                // Top/bottom boundary - bounce back
                if (ball.y < paddle1Y) {
                    ball.y = paddle1Y + ball.radius;
                    ball.vy = Math.abs(ball.vy);
                } else if (ball.y > paddle2Y + paddleHeight) {
                    ball.y = paddle2Y + paddleHeight - ball.radius;
                    ball.vy = -Math.abs(ball.vy);
                }
                
                // Grid collision - capture cells
                if (ball.y > gridTop && ball.y < gridBottom) {
                    const col = Math.floor(ball.x / cellWidth);
                    const row = Math.floor((ball.y - gridTop) / cellHeight);
                    
                    if (row >= 0 && row < GRID_ROWS && col >= 0 && col < GRID_COLS) {
                        const cell = territoryState.grid[row][col];
                        if (cell.owner !== ball.player) {
                            cell.owner = ball.player;
                            cell.flash = 1;
                            playTone(ball.player === 1 ? 400 : 500, 'sine', 0.05, 0.03);
                            createTerritoryParticles(
                                col * cellWidth + cellWidth / 2,
                                gridTop + row * cellHeight + cellHeight / 2,
                                ball.player === 1 ? 170 : 200,
                                5
                            );
                        }
                    }
                }
            }
            
            // Update particles
            territoryState.particles = territoryState.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.03;
                p.size *= 0.95;
                return p.alpha > 0;
            });
            
            // Update cell flash
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    if (territoryState.grid[row][col].flash > 0) {
                        territoryState.grid[row][col].flash -= 0.05;
                    }
                }
            }
            
            updateTerritoryScore();
        }

        function createTerritoryParticles(x, y, hue, count) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                territoryState.particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    hue,
                    alpha: 1,
                    size: Math.random() * 4 + 2
                });
            }
        }

        function updateTerritoryScore() {
            let score1 = 0, score2 = 0;
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    if (territoryState.grid[row][col].owner === 1) score1++;
                    else if (territoryState.grid[row][col].owner === 2) score2++;
                }
            }
            territoryState.score1 = score1;
            territoryState.score2 = score2;
            document.getElementById('territory-score-1').textContent = score1;
            document.getElementById('territory-score-2').textContent = score2;
        }

        function renderTerritory() {
            const ctx = territoryCtx;
            const w = territoryCanvas.width;
            const h = territoryCanvas.height;
            
            const paddleWidth = 120;
            const paddleHeight = 15;
            const paddle1Y = 100;
            const paddle2Y = h - 100 - paddleHeight;
            
            const gridTop = 130;
            const gridBottom = h - 130;
            const gridHeight = gridBottom - gridTop;
            const cellWidth = w / GRID_COLS;
            const cellHeight = gridHeight / GRID_ROWS;
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#0a2520');
            gradient.addColorStop(0.5, '#111827');
            gradient.addColorStop(1, '#0a1a28');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
            
            // Draw grid
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    const cell = territoryState.grid[row][col];
                    const x = col * cellWidth;
                    const y = gridTop + row * cellHeight;
                    
                    // Cell background
                    if (cell.owner === 1) {
                        const alpha = 0.4 + cell.flash * 0.4;
                        ctx.fillStyle = `rgba(20, 184, 166, ${alpha})`;
                    } else if (cell.owner === 2) {
                        const alpha = 0.4 + cell.flash * 0.4;
                        ctx.fillStyle = `rgba(14, 165, 233, ${alpha})`;
                    } else {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                    }
                    
                    ctx.fillRect(x + 1, y + 1, cellWidth - 2, cellHeight - 2);
                    
                    // Cell border
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, cellWidth, cellHeight);
                }
            }
            
            // Draw particles
            for (let p of territoryState.particles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${p.alpha})`;
                ctx.fill();
            }
            
            // Draw paddles
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#14b8a6';
            ctx.fillStyle = '#14b8a6';
            ctx.beginPath();
            ctx.roundRect(territoryState.paddle1X, paddle1Y, paddleWidth, paddleHeight, 8);
            ctx.fill();
            
            ctx.shadowColor = '#0ea5e9';
            ctx.fillStyle = '#0ea5e9';
            ctx.beginPath();
            ctx.roundRect(territoryState.paddle2X, paddle2Y, paddleWidth, paddleHeight, 8);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Draw balls
            for (let ball of territoryState.balls) {
                const hue = ball.player === 1 ? 170 : 200;
                
                // Glow
                const ballGradient = ctx.createRadialGradient(ball.x, ball.y, 0, ball.x, ball.y, ball.radius * 2);
                ballGradient.addColorStop(0, `hsla(${hue}, 100%, 70%, 0.8)`);
                ballGradient.addColorStop(1, `hsla(${hue}, 100%, 50%, 0)`);
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius * 2, 0, Math.PI * 2);
                ctx.fillStyle = ballGradient;
                ctx.fill();
                
                // Ball
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${hue}, 100%, 75%)`;
                ctx.fill();
                
                // Highlight
                ctx.beginPath();
                ctx.arc(ball.x - 3, ball.y - 3, ball.radius * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fill();
            }
            
            // Area labels
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(20, 184, 166, 0.4)';
            ctx.fillText('â† 41 çš„æŒ¡æ¿ â†’', w / 2, 85);
            ctx.fillStyle = 'rgba(14, 165, 233, 0.4)';
            ctx.fillText('â† å°å‘æ—¥è‘µå–µ çš„æŒ¡æ¿ â†’', w / 2, h - 70);
        }

        function endTerritoryGame() {
            territoryPaused = true;
            
            if (territoryTimerId) {
                clearInterval(territoryTimerId);
                territoryTimerId = null;
            }
            
            playRoundWinSound();
            
            const modal = document.getElementById('territory-end-modal');
            const icon = document.getElementById('territory-end-icon');
            const title = document.getElementById('territory-end-title');
            const finalScore = document.getElementById('territory-final-score');
            const msg = document.getElementById('territory-end-msg');
            
            modal.classList.remove('hidden');
            
            const s1 = territoryState.score1;
            const s2 = territoryState.score2;
            
            finalScore.innerHTML = `<span class="text-teal-400">${s1}</span> : <span class="text-sky-400">${s2}</span>`;
            
            if (s1 > s2) {
                icon.textContent = 'ğŸƒ';
                title.innerHTML = '<span class="text-teal-400">41</span> è·èƒœï¼';
                msg.textContent = territoryWinMsgs41[Math.floor(Math.random() * territoryWinMsgs41.length)];
            } else if (s2 > s1) {
                icon.textContent = 'ğŸŒ»';
                title.innerHTML = '<span class="text-sky-400">å°å‘æ—¥è‘µå–µ</span> è·èƒœï¼';
                msg.textContent = territoryWinMsgsSunflower[Math.floor(Math.random() * territoryWinMsgsSunflower.length)];
            } else {
                icon.textContent = 'ğŸ¤';
                title.innerHTML = 'å¹³å±€ï¼';
                msg.textContent = territoryDrawMsgs[Math.floor(Math.random() * territoryDrawMsgs.length)];
            }
        }

        function pauseTerritory() {
            territoryPaused = true;
            document.getElementById('territory-pause-modal').classList.remove('hidden');
        }

        function resumeTerritory() {
            document.getElementById('territory-pause-modal').classList.add('hidden');
            territoryPaused = false;
        }

        function restartTerritory() {
            document.getElementById('territory-pause-modal').classList.add('hidden');
            document.getElementById('territory-end-modal').classList.add('hidden');
            
            if (territoryTimerId) {
                clearInterval(territoryTimerId);
                territoryTimerId = null;
            }
            
            initTerritoryGame();
            territoryPaused = false;
            
            territoryTimerId = setInterval(() => {
                if (!territoryPaused && territoryState.timeLeft > 0) {
                    territoryState.timeLeft--;
                    document.getElementById('territory-timer').textContent = territoryState.timeLeft;
                    
                    if (territoryState.timeLeft <= 0) {
                        endTerritoryGame();
                    }
                }
            }, 1000);
        }

        function exitTerritory() {
            document.getElementById('territory-pause-modal').classList.add('hidden');
            document.getElementById('territory-end-modal').classList.add('hidden');
            
            if (territoryAnimationId) {
                cancelAnimationFrame(territoryAnimationId);
                territoryAnimationId = null;
            }
            if (territoryTimerId) {
                clearInterval(territoryTimerId);
                territoryTimerId = null;
            }
            
            document.getElementById('territory-game').classList.add('hidden');
            document.getElementById('territory-setup').classList.remove('hidden');
            backToMenu();
        }
    </script>
</body>
</html>
